// mobile/scripts/generate-theme-vars.js
// Node script to extract --* vars from light.css and dark.css and emit JSON + a TS file
const fs = require('fs')
const path = require('path')

function readFile(p) {
  return fs.existsSync(p) ? fs.readFileSync(p, 'utf8') : ''
}

// Extract variables from a CSS file.
// This looks for either :root { ... } blocks OR @media (prefers-color-scheme: ...) { :root { ... } }
function extractVarsFromCss(css, preferedMedia) {
  const vars = {}
  // First try to find @media block for the requested scheme (light/dark)
  if (preferedMedia) {
    // match @media (prefers-color-scheme: dark) { ... :root { ... } ... }
    const mediaRegex = new RegExp(
      '@media\\s*\\(prefers-color-scheme:\\s*' +
        preferedMedia +
        '\\)\\s*{([\\s\\S]*?):root\\s*{([\\s\\S]*?)}}',
      'i',
    )
    const m = css.match(mediaRegex)
    if (m && m[2]) {
      extractBlockVars(m[2], vars)
      return vars
    }
  }

  // fallback: try to find a top-level :root { ... } block
  const rootRegex = /:root\s*{([\s\S]*?)}/g
  let r
  while ((r = rootRegex.exec(css)) !== null) {
    extractBlockVars(r[1], vars)
  }

  return vars
}

function extractBlockVars(block, target) {
  // match --name: value;
  const varRegex = /--([a-z0-9\-]+)\s*:\s*([^;]+);/gi
  let v
  while ((v = varRegex.exec(block)) !== null) {
    const key = `--${v[1].trim()}`
    const val = v[2].trim()
    target[key] = val
  }
}

function build() {
  const themeDir = path.join(__dirname, '..', 'styles')
  const lightPath = path.join(themeDir, 'theme', 'light.css')
  const darkPath = path.join(themeDir, 'theme', 'dark.css')

  const lightCss = readFile(lightPath)
  const darkCss = readFile(darkPath)

  const lightVars = extractVarsFromCss(lightCss, 'light')
  const darkVars = extractVarsFromCss(darkCss, 'dark')

  // Also emit a TypeScript module exporting both maps (so you can import directly)
  const tsOut = `/* AUTO-GENERATED by scripts/generate-theme-vars.js - DO NOT EDIT */
export const lightThemeVars: Record<string, string> = ${JSON.stringify(lightVars, null, 2)} as const;
export const darkThemeVars: Record<string, string> = ${JSON.stringify(darkVars, null, 2)} as const;

export const getThemeVars = (scheme: 'light' | 'dark') => (scheme === 'dark' ? darkThemeVars : lightThemeVars);
`

  fs.writeFileSync(path.join(themeDir, 'themeVars.ts'), tsOut, 'utf8')

  console.log('Wrote themeVars.ts')
}

build()
